name: Build AMI with Packer

on:
  workflow_dispatch:  # 수동 실행
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: false
        type: boolean
      asg_desired_capacity:
        description: 'ASG Desired Capacity (leave empty to keep current)'
        required: false
        type: string
      asg_min_size:
        description: 'ASG Min Size (leave empty to keep current)'
        required: false
        type: string
      asg_max_size:
        description: 'ASG Max Size (leave empty to keep current)'
        required: false
        type: string
#   push:
#     paths:
#       - 'packer/**'
#       - 'packer.pkr.hcl'
#       - 'requirements.txt'
#       - '.github/workflows/build-ami.yml'
#     branches:
#       - main
#   schedule:
    # 매월 1일 자정에 자동 실행 (보안 업데이트 반영)
    # - cron: '0 0 1 * *'

env:
  AWS_REGION: ap-northeast-2
  PACKER_VERSION: "1.11.0"

jobs:
  build-ami:
    name: Build Custom AMI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check Packer variables file
        id: check-vars
        run: |
          if [ ! -f "packer/variables.pkr.hcl" ]; then
            echo "❌ packer/variables.pkr.hcl 파일이 없습니다."
            echo "packer/variables.pkr.hcl.example을 복사하여 설정하세요."
            exit 1
          fi
          echo "✅ 변수 파일 확인 완료"

      - name: Initialize Packer plugins
        run: |
          echo "Packer 플러그인 초기화 중..."
          packer init packer.pkr.hcl
          echo "✅ Packer 플러그인 초기화 완료"

      - name: Validate Packer configuration
        run: |
          echo "Packer 설정 검증 중..."
          # source_ami_id를 빈 문자열로 강제 설정하여 항상 최신 공식 Ubuntu AMI 사용
          # 이전 커스텀 AMI를 사용하지 않도록 보장
          packer validate \
            -var-file=packer/variables.pkr.hcl \
            -var 'source_ami_id=' \
            packer.pkr.hcl
          echo "✅ Packer 설정 검증 완료"

      - name: Make scripts executable
        run: |
          chmod +x packer/scripts/*.sh
          echo "✅ 스크립트 실행 권한 부여 완료"

      - name: Build AMI
        id: build
        run: |
          echo "================================"
          echo "AMI 빌드 시작"
          echo "================================"
          echo "이 작업은 10-15분 정도 소요될 수 있습니다."
          echo ""
          
          # Packer 빌드 실행
          # source_ami_id를 빈 문자열로 강제 설정하여 항상 최신 공식 Ubuntu AMI 사용
          # 이전 커스텀 AMI를 사용하지 않도록 보장 (완전히 새로운 AMI 빌드)
          packer build \
            -var-file=packer/variables.pkr.hcl \
            -var 'source_ami_id=' \
            packer.pkr.hcl | tee packer-build.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "❌ Packer 빌드 실패 (종료 코드: $BUILD_EXIT_CODE)"
            echo "빌드 로그 (마지막 100줄):"
            tail -n 100 packer-build.log
            exit 1
          fi
          
          echo ""
          echo "Packer manifest 파일 확인 중..."
          if [ ! -f "packer-manifest.json" ]; then
            echo "❌ packer-manifest.json 파일이 생성되지 않았습니다."
            echo "빌드 로그 (마지막 100줄):"
            tail -n 100 packer-build.log
            exit 1
          fi
          
          # Packer manifest 파일에서 AMI ID 추출 (가장 신뢰할 수 있는 방법)
          echo "Packer manifest 파일에서 AMI ID 추출 중..."
          # jq 설치 (없으면 설치)
          if ! command -v jq &> /dev/null; then
            echo "jq 설치 중..."
            sudo apt-get update -qq && sudo apt-get install -y jq
          fi
          
          # manifest 파일 구조: {"builds": [{"name": "...", "artifact_id": "ap-northeast-2:ami-xxxxx", ...}]}
          # artifact_id에서 AMI ID 추출
          AMI_ID=$(jq -r '.builds[-1].artifact_id' packer-manifest.json 2>/dev/null | grep -oP 'ami-[a-z0-9]{17}' | head -1)
          
          # jq로 찾지 못한 경우 다른 방법 시도
          if [ -z "$AMI_ID" ] || [ "$AMI_ID" = "null" ]; then
            echo "jq로 찾지 못함, 다른 방법으로 추출 시도..."
            # manifest 파일에서 직접 추출
            AMI_ID=$(grep -oP 'ami-[a-z0-9]{17}' packer-manifest.json | head -1)
          fi
          
          # manifest에서 찾지 못한 경우 로그에서 추출
          if [ -z "$AMI_ID" ]; then
            echo "로그에서 AMI ID 추출 시도 중..."
            # Packer 출력 형식: "amazon-ebs.anonymous_project: AMIs were created:\namazon-ebs.anonymous_project: ap-northeast-2: ami-xxxxx"
            AMI_ID=$(grep -i "AMIs were created" packer-build.log -A 5 | grep -oP 'ami-[a-z0-9]{17}' | head -1)
          fi
          
          # 여전히 찾지 못한 경우 다른 패턴 시도
          if [ -z "$AMI_ID" ]; then
            echo "다른 패턴으로 AMI ID 추출 시도 중..."
            AMI_ID=$(grep -oP 'ami-[a-z0-9]{17}' packer-build.log | tail -1)
          fi
          
          if [ -z "$AMI_ID" ]; then
            echo "❌ AMI ID를 찾을 수 없습니다."
            echo ""
            echo "Packer manifest 파일 내용:"
            cat packer-manifest.json
            echo ""
            echo "Packer 빌드 로그 (마지막 100줄):"
            tail -n 100 packer-build.log
            exit 1
          fi
          
          echo "AMI_ID=$AMI_ID" >> $GITHUB_ENV
          echo "✅ AMI 빌드 완료: $AMI_ID"
          
          # 출력 설정
          echo "ami-id=$AMI_ID" >> $GITHUB_OUTPUT
          
          # 디버깅: manifest 파일 내용 출력
          echo ""
          echo "Packer manifest 파일 내용:"
          cat packer-manifest.json | jq '.' 2>/dev/null || cat packer-manifest.json

      - name: Verify AMI exists
        run: |
          echo "생성된 AMI가 실제로 존재하는지 확인 중..."
          AMI_ID="${{ env.AMI_ID }}"
          AWS_REGION="${{ env.AWS_REGION }}"
          
          # AMI 존재 여부 확인
          AMI_INFO=$(aws ec2 describe-images \
            --image-ids "$AMI_ID" \
            --region "$AWS_REGION" \
            --query 'Images[0]' \
            --output json 2>&1)
          
          if echo "$AMI_INFO" | grep -q "InvalidAMIID"; then
            echo "❌ AMI가 존재하지 않습니다: $AMI_ID"
            echo "AMI 정보: $AMI_INFO"
            exit 1
          elif echo "$AMI_INFO" | grep -q "ImageId"; then
            echo "✅ AMI 확인 완료: $AMI_ID"
            echo "AMI 상세 정보:"
            echo "$AMI_INFO" | jq -r '{ImageId, Name, State, CreationDate, OwnerId}' 2>/dev/null || echo "$AMI_INFO"
          else
            echo "⚠️  AMI 확인 중 오류 발생: $AMI_INFO"
            echo "AMI가 존재하는지 수동으로 확인하세요."
          fi

      - name: Save AMI ID to Parameter Store
        run: |
          echo "AMI ID를 Systems Manager Parameter Store에 저장 중..."
          
          aws ssm put-parameter \
            --name "/anonymous-project/ami-id" \
            --value "${{ env.AMI_ID }}" \
            --type "String" \
            --description "Latest AMI ID for anonymous-project built on $(date -u +%Y-%m-%d)" \
            --overwrite \
            --region ${{ env.AWS_REGION }}
          
          echo "✅ AMI ID 저장 완료: ${{ env.AMI_ID }}"

      - name: Tag AMI
        run: |
          echo "AMI에 태그 추가 중..."
          
          aws ec2 create-tags \
            --resources ${{ env.AMI_ID }} \
            --tags \
              Key=Name,Value=anonymous-project-ami \
              Key=Project,Value=anonymous-project \
              Key=Environment,Value=production \
              Key=BuiltBy,Value=github-actions \
              Key=BuildDate,Value=$(date -u +%Y-%m-%d) \
              Key=CommitSHA,Value=${{ github.sha }} \
            --region ${{ env.AWS_REGION }}
          
          echo "✅ 태그 추가 완료"

      - name: Upload build manifest
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: packer-manifest
          path: |
            packer-manifest.json
            packer-build.log
          retention-days: 30

      - name: Build summary
        if: always()
        run: |
          echo "================================"
          echo "AMI 빌드 요약"
          echo "================================"
          echo "AMI ID: ${{ env.AMI_ID }}"
          echo "리전: ${{ env.AWS_REGION }}"
          echo "커밋: ${{ github.sha }}"
          echo "브랜치: ${{ github.ref }}"
          echo ""
          echo "AMI 확인:"
          echo "https://console.aws.amazon.com/ec2/home?region=${{ env.AWS_REGION }}#Images:visibility=owned-by-me;search=${{ env.AMI_ID }}"
          echo ""
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ AMI 빌드가 성공적으로 완료되었습니다!"
          else
            echo "❌ AMI 빌드가 실패했습니다."
            echo "로그를 확인하세요."
          fi

        # [5] 최신 AMI ID 가져오기
      - name: Get Latest AMI ID
        id: ami
        run: |
            echo "[AMI] Retrieving latest AMI..."
            AMI_ID=$(aws ec2 describe-images \
                --owners self \
                --filters "Name=name,Values=anonymous-project-*" \
                --query "Images | sort_by(@, &CreationDate)[-1].ImageId" \
                --output text)
            echo "AMI_ID=$AMI_ID" >> $GITHUB_ENV
            echo "[AMI] Latest AMI: $AMI_ID"

        # [6] Launch Template 새 버전 생성
      - name: Create New Launch Template Version
        run: |
            LT_ID=${{ secrets.LAUNCH_TEMPLATE_ID }}
            echo "[LT] Fetching current version..."
            LATEST_VERSION=$(aws ec2 describe-launch-template-versions \
                --launch-template-id $LT_ID \
                --query 'sort_by(LaunchTemplateVersions, &VersionNumber)[-1].VersionNumber' \
                --output text)
            echo "[LT] Creating new version with AMI: ${AMI_ID}"
            echo "[LT] Note: Keeping UserData from source version (may include Lifecycle Hook completion)"
            # 원본 Launch Template의 UserData를 유지 (Lifecycle Hook 완료 로직이 있을 수 있음)
            # ImageId만 업데이트하고 나머지는 source version에서 가져옴
            aws ec2 create-launch-template-version \
                --launch-template-id $LT_ID \
                --source-version $LATEST_VERSION \
                --launch-template-data "{
                \"ImageId\": \"${AMI_ID}\",
                \"TagSpecifications\": [
                    {\"ResourceType\": \"instance\", \"Tags\": [{\"Key\": \"Name\", \"Value\": \"anonymous-project\"}]}
                ]
                }"

        # [7] 기본 Launch Template 버전 갱신
      - name: Set Default Launch Template Version
        id: lt_version
        run: |
            LT_ID=${{ secrets.LAUNCH_TEMPLATE_ID }}
            LATEST_VERSION=$(aws ec2 describe-launch-template-versions \
                --launch-template-id $LT_ID \
                --query 'sort_by(LaunchTemplateVersions, &VersionNumber)[-1].VersionNumber' \
                --output text)
            aws ec2 modify-launch-template \
                --launch-template-id $LT_ID \
                --default-version $LATEST_VERSION
            echo "[LT] Default version updated to ${LATEST_VERSION}"
            echo "LATEST_VERSION=${LATEST_VERSION}" >> $GITHUB_ENV
            echo "LT_ID=${LT_ID}" >> $GITHUB_ENV

        # [8] ASG의 Launch Template 버전 업데이트 (중요!)
      - name: Update ASG Launch Template Version
        run: |
            echo "[ASG] Updating Launch Template version..."
            ASG_NAME="${{ secrets.ASG_NAME }}"
            LT_ID="${{ env.LT_ID }}"
            LATEST_VERSION="${{ env.LATEST_VERSION }}"
            
            echo "[ASG] Current ASG configuration:"
            aws autoscaling describe-auto-scaling-groups \
                --auto-scaling-group-names $ASG_NAME \
                --query 'AutoScalingGroups[0].{LaunchTemplate:LaunchTemplate,DesiredCapacity:DesiredCapacity,MinSize:MinSize,MaxSize:MaxSize}' \
                --output json
            
            echo "[ASG] Updating to Launch Template version ${LATEST_VERSION}..."
            aws autoscaling update-auto-scaling-group \
                --auto-scaling-group-name $ASG_NAME \
                --launch-template "LaunchTemplateId=${LT_ID},Version=${LATEST_VERSION}"
            
            echo "[ASG] Launch Template version updated successfully to ${LATEST_VERSION}"

        # [9] Auto Scaling Group 설정 업데이트 (선택적)
      - name: Update ASG Capacity Settings
        if: ${{ inputs.asg_desired_capacity != '' || inputs.asg_min_size != '' || inputs.asg_max_size != '' }}
        run: |
            echo "[ASG] Updating capacity settings..."
            ASG_NAME="${{ secrets.ASG_NAME }}"
            UPDATE_ARGS="--auto-scaling-group-name $ASG_NAME"
            
            if [ -n "${{ inputs.asg_min_size }}" ]; then
                UPDATE_ARGS="$UPDATE_ARGS --min-size ${{ inputs.asg_min_size }}"
                echo "[ASG] Min Size: ${{ inputs.asg_min_size }}"
            fi
            
            if [ -n "${{ inputs.asg_max_size }}" ]; then
                UPDATE_ARGS="$UPDATE_ARGS --max-size ${{ inputs.asg_max_size }}"
                echo "[ASG] Max Size: ${{ inputs.asg_max_size }}"
            fi
            
            if [ -n "${{ inputs.asg_desired_capacity }}" ]; then
                UPDATE_ARGS="$UPDATE_ARGS --desired-capacity ${{ inputs.asg_desired_capacity }}"
                echo "[ASG] Desired Capacity: ${{ inputs.asg_desired_capacity }}"
            fi
            
            aws autoscaling update-auto-scaling-group $UPDATE_ARGS
            echo "[ASG] Capacity settings updated successfully."

        # [10] ASG 설정 확인 (디버깅용)
      - name: Verify ASG Configuration
        run: |
            echo "[ASG] Verifying ASG configuration..."
            ASG_NAME="${{ secrets.ASG_NAME }}"
            aws autoscaling describe-auto-scaling-groups \
                --auto-scaling-group-names $ASG_NAME \
                --query 'AutoScalingGroups[0].{
                    LaunchTemplate:LaunchTemplate,
                    DesiredCapacity:DesiredCapacity,
                    MinSize:MinSize,
                    MaxSize:MaxSize,
                    Instances:Instances[*].{InstanceId:InstanceId,LaunchTemplate:LaunchTemplate}
                }' \
                --output json
            echo "[ASG] Configuration verification complete."

        # [11] Auto Scaling Group 롤링 업데이트 트리거
      - name: Trigger ASG Rolling Update
        run: |
            echo "[ASG] Starting rolling update..."
            ASG_NAME="${{ secrets.ASG_NAME }}"
            
            # Instance Refresh 시작
            REFRESH_ID=$(aws autoscaling start-instance-refresh \
                --auto-scaling-group-name $ASG_NAME \
                --preferences '{
                    "MinHealthyPercentage": 50,
                    "InstanceWarmup": 300,
                    "CheckpointPercentages": [50, 100],
                    "CheckpointDelay": 60,
                    "SkipMatching": false
                }' \
                --query 'InstanceRefreshId' \
                --output text)
            
            echo "[ASG] Rolling update triggered successfully."
            echo "[ASG] Instance Refresh ID: ${REFRESH_ID}"
            echo "[ASG] Monitor progress with: aws autoscaling describe-instance-refreshes --auto-scaling-group-name ${ASG_NAME} --instance-refresh-ids ${REFRESH_ID}"


